import os
from typing import Set, List

from astrbot.core.platform.sources.aiocqhttp.aiocqhttp_message_event import (
    AiocqhttpMessageEvent,
)


class RC:
    def __init__(self):
        self.load_stop_words()
        self.llm_prompt = "\n".join(
            [
                "**ä½ æ˜¯ä¸€ä¸ªé£æ§æ£€æŸ¥å™¨ï¼Œç”¨äºæ£€æµ‹ç”¨æˆ·åœ¨ç¾¤èŠä¸­çš„å‘è¨€æ˜¯å¦ç¬¦åˆç½‘ç»œé“å¾·ã€‚**",
                "",
                "## ç½‘ç»œé“å¾·ï¼š",
                "",
                "### â€œç»å¯¹çº¢çº¿â€æ¸…å•ï¼ˆé›¶å®¹å¿ï¼‰",
                "",
                "è¿™äº›å†…å®¹æ— è®ºæ˜¯å¦ç©ç¬‘ï¼Œåœ¨ä»»ä½•æ–‡åŒ–å’Œè¯­å¢ƒä¸‹éƒ½å…·æœ‰æé«˜çš„å±å®³æ€§ï¼Œé€šå¸¸ä¹Ÿæ˜¯æ³•å¾‹æ˜ä»¤ç¦æ­¢çš„ï¼Œä¾‹å¦‚ï¼š",
                "",
                "- ä¸¥é‡è¿æ³•å†…å®¹â€‹â€‹ï¼šæ˜ç¡®ç­–åˆ’æˆ–å®£æ‰¬ææ€–ä¸»ä¹‰ã€æš´åŠ›çŠ¯ç½ªï¼ˆå¦‚è¯¦ç»†è°‹æ€ã€çˆ†ç‚¸æ–¹æ³•ï¼‰ã€å„¿ç«¥è‰²æƒ…ã€äººå£è´©å–ç­‰",
                "- ä¸¥é‡çš„ã€ç›´æ¥çš„æš´åŠ›å¨èƒâ€‹â€‹ï¼šé’ˆå¯¹ä¸ªäººæˆ–ç¾¤ä½“çš„æ˜ç¡®äººèº«å¨èƒï¼ˆå¦‚â€œæˆ‘è¦æ€äº†XXXâ€ã€â€œæˆ‘ä»¬ä»Šæ™šå»çƒ§äº†é‚£æ ‹æ¥¼â€ï¼‰",
                "- æåº¦ä»‡æ¨è¨€è®ºâ€‹â€‹ï¼šåŸºäºç§æ—ã€æ°‘æ—ã€å®—æ•™ã€å›½ç±ã€æ€§åˆ«ã€æ€§å–å‘ã€æ®‹ç–¾ç­‰ï¼Œå…¬å¼€å‘å¸ƒæ—¨åœ¨ç…½åŠ¨æ­§è§†ã€æ•Œæ„æˆ–æš´åŠ›çš„è¨€è®ºã€‚",
                "",
                "æ— è®ºæ˜¯å¦ä¸ºå¼€ç©ç¬‘ï¼Œå‡åˆ¤å®šä¸ºä¸ç¬¦åˆç½‘ç»œé“å¾·ã€‚",
                "",
                "### å¯¹äºéâ€œçº¢çº¿â€å†…å®¹ï¼Œè¿›è¡Œå¤šç»´åº¦äº¤å‰åˆ†æ",
                "",
                "å¯¹äºå¤§å¤šæ•°å¤„äºç°è‰²åœ°å¸¦çš„è¨€è®ºï¼Œéœ€è¦ä»ä»¥ä¸‹å‡ ä¸ªç»´åº¦è¿›è¡ŒåŠ æƒåˆ¤æ–­ï¼š",
                "",
                "1. è¯æ±‡ä¸ä¸»é¢˜åˆ†æï¼ˆWhat is said?ï¼‰ â€‹â€‹å…³é”®è¯è¯†åˆ«â€‹â€‹ï¼šæ˜¯å¦åŒ…å«å…¬è®¤çš„ä¾®è¾±æ€§è¯æ±‡ã€è„è¯ã€æ­§è§†æ€§ç”¨è¯­ï¼ˆå¦‚æ¶‰åŠç§æ—ã€æ€§åˆ«ã€æ®‹ç–¾çš„è´¬æŸè¯ï¼‰ï¼Ÿ â€‹â€‹ä¸»é¢˜æ•æ„Ÿæ€§â€‹â€‹ï¼šè¯é¢˜æ˜¯å¦æ¶‰åŠæ•æ„Ÿè®®é¢˜ï¼ˆå¦‚æ€§ã€æš´åŠ›ã€ç¾éš¾ã€æ‚²å‰§äº‹ä»¶ï¼‰ï¼Ÿä¾‹å¦‚ï¼Œå…³äºåœ°éœ‡ã€ç©ºéš¾çš„â€œç©ç¬‘â€é£é™©æé«˜ã€‚",
                "2. å¥å¼ä¸æƒ…æ„Ÿåˆ†æï¼ˆHow is it said?ï¼‰ â€‹â€‹å¤¸å¼ ä¸åè®½å¥å¼â€‹â€‹ï¼šå¥å­æ˜¯å¦åŒ…å«æ˜æ˜¾çš„å¤¸å¼ ã€æ¯”å–»æˆ–åè®½ç»“æ„ï¼Ÿä¾‹å¦‚ï¼Œâ€œæˆ‘é¥¿å¾—èƒ½åƒä¸‹ä¸€å¤´ç‰›â€æ˜¾ç„¶æ˜¯å¤¸å¼ ï¼Œä½†â€œè¿™ä¸ªè®¡åˆ’å®Œç¾å¾—å°±åƒä¸€åœºç¾éš¾â€å°±å¯èƒ½æ˜¯åè®½ï¼Œéœ€è¦ç»“åˆä¸»é¢˜çœ‹ã€‚ â€‹â€‹è¡¨æƒ…ç¬¦å·å’Œè¯­æ°”è¯â€‹â€‹ï¼šå¥å°¾æ˜¯å¦æœ‰ğŸ˜‚ã€ğŸ¶ï¼ˆç‹—å¤´ä¿å‘½ï¼‰ã€/jï¼ˆjokingçš„ç¼©å†™ï¼‰ã€/sï¼ˆsarcasmçš„ç¼©å†™ï¼‰ç­‰ç”¨äºæ ‡è¯†ç©ç¬‘æˆ–åè®½çš„ç¬¦å·ï¼Ÿâ€‹â€‹è¿™æ˜¯éå¸¸é‡è¦çš„ä¿¡å·â€‹â€‹ã€‚ â€‹â€‹æƒ…æ„Ÿææ€§â€‹â€‹ï¼šAIå¯ä»¥åˆ†æè¿™å¥è¯çš„æƒ…æ„Ÿæ˜¯æç«¯çš„è´Ÿé¢ï¼Œè¿˜æ˜¯ä¸­æ€§çš„è°ƒä¾ƒã€‚",
                "3. æ¦‚ç‡ä¸å¸¸è§æ¨¡å¼åˆ†æï¼ˆPatternï¼‰ â€‹â€‹å¸¸è§ç©ç¬‘æ¨¡æ¿â€‹â€‹ï¼šç³»ç»Ÿå¯ä»¥å­¦ä¹ å¸¸è§çš„ç©ç¬‘æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œâ€œå‹å°½äº†â€ã€â€œæ‹”åˆ€å§â€ã€â€œä½ å·æ²¡äº†â€ç­‰åœ¨ç‰¹å®šç¤¾ç¾¤ä¸­é€šå¸¸æ˜¯å®‰å…¨çš„è°ƒä¾ƒã€‚ â€‹â€‹æ”»å‡»æ€§æ¦‚ç‡â€‹â€‹ï¼šè®­ç»ƒæ¨¡å‹æ¥é¢„æµ‹ä¸€å¥è¯è¢«å¤šæ•°äººè®¤ä¸ºæ˜¯æ”»å‡»æ€§è¨€è®ºçš„æ¦‚ç‡ã€‚",
                "",
                "### åˆé€‚çš„ç©ç¬‘æˆ–è€…å®¢è§‚çš„è¯„ä»·",
                "",
                "è¿™ä¸ªæ ‡å‡†æ— æ³•åšåˆ°100%ç²¾ç¡®ï¼Œä½†å¯ä»¥ä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„â€‹â€‹åˆ†ææ¡†æ¶â€‹â€‹ã€‚æ ¸å¿ƒåœ¨äºâ€‹â€‹æ„å›¾ï¼ˆIntentï¼‰â€‹â€‹ å’Œâ€‹â€‹å½±å“ï¼ˆImpactï¼‰â€‹â€‹ çš„æƒè¡¡ã€‚æ ¸å¿ƒåŸåˆ™ï¼šå…ˆçœ‹æ„å›¾ï¼Œå†çœ‹å½±å“â€‹ã€‚",
                "",
                "1. æ„å›¾ï¼ˆIntentï¼‰ï¼šå‘è¨€è€…çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿâ€‹â€‹ â€‹â€‹åˆé€‚çš„ç©ç¬‘â€‹â€‹ï¼šç›®çš„æ˜¯â€‹â€‹åˆ›é€ æ¬¢ä¹ã€å¢è¿›äº²å’Œã€å¹½é»˜åœ°è§£æ„å‹åŠ›â€‹â€‹ã€‚æ ¸å¿ƒæ˜¯â€‹â€‹å…±äº«â€‹â€‹ï¼ˆShared enjoymentï¼‰ã€‚ â€‹â€‹å®¢è§‚çš„è¯„ä»·â€‹â€‹ï¼šç›®çš„æ˜¯â€‹â€‹è¡¨è¾¾è§‚ç‚¹ã€æå‡ºæ‰¹è¯„ã€åˆ†äº«ä¿¡æ¯â€‹â€‹ã€‚æ ¸å¿ƒæ˜¯â€‹â€‹äº¤æµâ€‹â€‹ï¼ˆExchange of ideasï¼‰ã€‚",
                "2. å½±å“ï¼ˆImpactï¼‰ï¼šå¬åˆ°è¿™å¥è¯çš„äººæ„Ÿå—å¦‚ä½•ï¼Ÿâ€‹â€‹â€‹â€‹åˆé€‚çš„ç©ç¬‘â€‹â€‹ï¼šå½±å“æ˜¯â€‹â€‹ä¸­æ€§æˆ–ç§¯æçš„â€‹â€‹ï¼Œä¸ä¼šè®©ç¾¤ä½“å†…çš„ä»»ä½•äººæ„Ÿåˆ°è¢«é’ˆå¯¹ã€ç¾è¾±æˆ–æ’æ–¥ã€‚â€‹â€‹å®¢è§‚çš„è¯„ä»·â€‹â€‹ï¼šå½±å“æ˜¯â€‹â€‹å»ºè®¾æ€§çš„â€‹â€‹ï¼Œå³ä½¿è§‚ç‚¹å°–é”ï¼Œä¹Ÿèƒ½æ¨åŠ¨è®¨è®ºï¼Œè€Œéå¼•å‘äººèº«æ”»å‡»ã€‚",
                "",
                "## è¾“å…¥ä¸è¾“å‡º",
                "",
                "- è¾“å…¥ï¼šç”¨æˆ·åœ¨ç¾¤èŠä¸­å‘é€çš„æ¶ˆæ¯",
                "- è¾“å‡ºï¼šæ¶æ„ç¨‹åº¦ï¼ŒèŒƒå›´ä¸º0-1ï¼Œ0è¡¨ç¤ºæ— æ¶æ„ï¼Œ1è¡¨ç¤ºå®Œå…¨æ¶æ„ã€‚ä»…è¿”å›æœ€å¤šä¸¤ä½å°æ•°çš„æµ®ç‚¹æ•°å³å¯ï¼Œä¸è¦è¿”å›å…¶ä»–åˆ†æã€‚",
            ]
        )

    async def treat(self, event: AiocqhttpMessageEvent):
        """é£æ§å¤„ç†"""
        client = event.bot
        group_id = int(event.get_group_id())
        user_id = int(event.get_sender_id())
        self_id = int(event.get_self_id())
        message_id = int(event.message_obj.message_id)

        # æ’¤å›
        await client.delete_msg(
            message_id=message_id,
            self_id=self_id,
        )

        # ç¦è¨€
        await client.set_group_ban(
            group_id=group_id,
            user_id=user_id,
            duration=10 * 60,
            self_id=self_id,
        )

        # æç¤º
        yield event.plain_result(
            "æ£€æµ‹åˆ°å¯èƒ½çš„è¿è§„å†…å®¹ï¼Œå‘è¨€è¯·éµå®ˆç½‘ç»œé“å¾·ï¼\nï¼ˆè‹¥è¯¯åˆ¤è¯·è”ç³»ç¾¤é£çºªå§”å‘˜å¤„ç†ï¼‰"
        )
        event.stop_event()

    def get_rc_coefficient(self, message: str) -> float:
        """
        è®¡ç®—é£æ§ç³»æ•°

        :param message: æ¶ˆæ¯å†…å®¹
        :return: é£æ§ç³»æ•° (0-1.0)
        """
        message = message.strip().lower()
        if not message:
            return 0.0

        rc_list = self.get_rc_list(message)
        if not rc_list:
            return 0.0

        matched_positions = set()
        for word in rc_list:
            start = 0
            while True:
                pos = message.find(word, start)
                if pos == -1:
                    break
                for i in range(pos, pos + len(word)):
                    matched_positions.add(i)
                start = pos + 1

        rc_length = len(matched_positions)
        return min(rc_length / len(message), 1.0)

    def get_rc_list(self, message: str) -> List[str]:
        """è§£æè¿ç¦è¯"""
        if not self.sw_list:
            self.load_stop_words()

        rc_list = []
        matched_positions = set()
        for sw in self.sw_list:
            start = 0
            found = False
            while True:
                pos = message.find(sw, start)
                if pos == -1:
                    break
                overlap = False
                for i in range(pos, pos + len(sw)):
                    if i in matched_positions:
                        overlap = True
                        break
                if not overlap:
                    rc_list.append(sw)
                    found = True
                    # æ ‡è®°è¿™äº›ä½ç½®ä¸ºå·²åŒ¹é…
                    for i in range(pos, pos + len(sw)):
                        matched_positions.add(i)
                start = pos + 1

        return rc_list

    def load_stop_words(
        self,
        path=os.path.join(
            os.path.dirname(os.path.abspath(__file__)), "keyword", "keywords.txt"
        ),
    ) -> list[str]:
        """è·å–è¿ç¦è¯åˆ—è¡¨"""
        word_set = set()
        try:
            with open(path, "r", encoding="utf-8") as file:
                for line in file:
                    line = line.strip().lower()
                    if line:
                        word_set.add(line)
        except FileNotFoundError:
            raise FileNotFoundError(f"æ— æ³•æ‰¾åˆ°è¿ç¦è¯æ–‡ä»¶ï¼š{path}")

        self.sw_list = sorted(word_set, key=len, reverse=True)
        return self.sw_list


rc = RC()

if __name__ == "__main__":
    # æµ‹è¯•ç¤ºä¾‹
    test_cases = [
        "å¦ˆ",  # å•ä¸ªè¯
        "ä½ å¦ˆ",  # åŒ…å«é‡å è¯
        "ä½ å¦ˆå¦ˆ",  # åŒ…å«å¤šä¸ªé‡å è¯
        "æ­£å¸¸æ–‡æœ¬",  # æ— è¿ç¦è¯
        "ä½ å¦ˆçœŸæ˜¯ä¸ªå¥½äººï¼Œå¦ˆå¦ˆæˆ‘çˆ±ä½ ",  # å¤šä¸ªè¿ç¦è¯
        "ä¸è¦ç†è§£å‚»é€¼å’Œä¸²å­ä»¥åŠçœŸæ­£çš„å­å­",  # æ¨¡æ£±ä¸¤å¯
    ]

    for test in test_cases:
        coefficient = rc.get_rc_coefficient(test)
        rc_list = rc.get_rc_list(test)
        print(f"æ–‡æœ¬: '{test}'")
        print(f"è¿ç¦è¯: {rc_list}")
        print(f"ç³»æ•°: {coefficient:.3f}")
        print("-" * 50)
